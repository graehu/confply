<html>
  <header>
    <link rel="stylesheet" href="server.css"/>
    <h1 class="confply">./confply.py --listen</h1>
  </header>
  <body>
    <div id="launcher_div" class="logbox"></div>
    <div id="config_div"></div>
    <details> <summary>debug</summary>
      <div id="debug_div" class="logbox"></div>
    </details>
    <script>
      // #todo: httpget add failure handling
      // for the various gets below.
      var currentrun = null;
      var running_button = null;
      var run_queue = [];
      var debug_div = document.getElementById("debug_div");
      function debug_log(message)
      {
	  if(debug_div !== null)
	  {
	      debug_div.innerHTML += message+"<br>";
	  }
      };
      function httpGet(theUrl, callback)
      {
	  debug_log("GET "+theUrl);
	  var xmlHttp = new XMLHttpRequest();
	  xmlHttp.onreadystatechange = function() { 
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
	      {
		  debug_log("GET "+theUrl+" response:");
		  try
		  {
		      var holder = JSON.parse(xmlHttp.responseText);
		      var debug_str = "<details><summary>json</summary>"+JSON.stringify(holder, null, 2)+"</details>";
		      debug_log(debug_str);
		  }
		  catch(err){debug_log("response not json parsable");}
		  callback(xmlHttp.responseText);
	      }
	  }
	  xmlHttp.open("GET", theUrl, true); // true for asynchronous 
	  xmlHttp.send(null);
      };
      function httpPost(theUrl, data, callback)
      {
	  debug_log("POST "+theUrl);
	  debug_log(data);
	  var xmlHttp = new XMLHttpRequest();
	  xmlHttp.onreadystatechange = function() {
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
	      {
		  debug_log("POST "+theUrl+" response:");
		  try
		  {
		      var holder = JSON.parse(xmlHttp.responseText);
		      var debug_str = "<details><summary>json</summary>"+JSON.stringify(holder, null, 2)+"</details>";
		      debug_log(debug_str);
		  }
		  catch(err){debug_log("response not json parsable");}
		  callback(xmlHttp.responseText);
	      }
	  }
	  xmlHttp.open("POST", theUrl, true); // true for asynchronous
	  xmlHttp.send(data);
      };
      function submit_form()
      {
	  var config_form = document.getElementById("config_form");
	  var confply_form = document.getElementById("confply_form");
	  var formData = {};
	  formData["confply"] = {};
	  // create json parsable dictionary from form
	  for(var form of [config_form, confply_form])
	  {
	      var dict = {}
	      for(var [k, v] of new FormData(form))
	      {
		  v = v.replace(/[\u2018\u2019]/g, "'");
		  v = v.replace(/[\u201C\u201D]/g, '"');
		  v = v.replace(/[\u2013\u2014]/g, '-');
 		  v = v.replace(/[\u2026]/g, '...');
		  if(k in dict)
		  {
		      if(Array.isArray(dict[k])) { dict[k].push(v); }
		      else { dict[k] = [dict[k], v]; }
		  }
		  else
		  {
		      try { dict[k] = JSON.parse(v); }
		      catch(err) { dict[k] = v; }
		  }
	      };
	      if(form === config_form)
	      {
		  formData = dict;
	      }
	      else
	      {
		  formData["confply"] = dict;
	      }
	  }
	  httpPost("/api/run.config", JSON.stringify(formData), function(response)
		   {
		   });
      };
      httpGet("/api/get.config.form", function(response)
	      {
		  var response = JSON.parse(response);
		  if(response["ok"])
		  {
		      var form  = document.getElementById("config_div");
		      form.innerHTML = response["html"];
		      var button = document.createElement("button");
		      button.setAttribute("onclick", "submit_form()");
		      button.innerHTML = "run config";
		      form.appendChild(button);
		  }
	      });
      httpGet("/api/get.aliases", function(response)
	      {
		  var run_buttons = document.getElementById("run_buttons");
		  response = JSON.parse(response);
		  if(response["ok"])
		  {
		      for(var key in response["aliases"])
		      {
			  var pre = document.createElement("pre");
			  var button = document.createElement("button");
			  button.setAttribute("onclick", "run_alias('"+key+"')");
			  button.setAttribute("class", "run_button");
			  button.setAttribute("id", key+"_button");
			  button.innerHTML = key;
			  var span = document.createElement("span");
			  span.setAttribute("class", "run_command");
			  span.innerHTML = response["aliases"][key];
			  run_buttons.appendChild(pre);
			  pre.appendChild(button);
			  pre.appendChild(span);
		      }
		  }
	      });
      httpGet("/api/get.launcher", function(response)
	      {
		  var launcher_div = document.getElementById("launcher_div");
		  response = JSON.parse(response);
		  if(response["ok"])
		  {
		      launcher_div.innerHTML = response["path"];   
		  }
	      });
      function run_alias(alias)
      {
	  if(running_button === null)
	  {
	      running_button = document.getElementById(alias+"_button");
	      running_button.setAttribute("class", "run_button running");
	      currentrun = alias +" - "+ new Date().toLocaleString();
	      httpGet("/api/run.alias?alias="+alias, run_complete);
	  }
	  else if(running_button.id !== (alias+"_button"))
	  {
	      var index = run_queue.indexOf(alias);
	      var button = document.getElementById(alias+"_button");
	      if (index >= 0)
	      {
		  run_queue.splice(index, 1);
		  button.setAttribute("class", "run_button");
	      }
	      else
	      {
		  button.setAttribute("class", "run_button queued");
		  run_queue.push(alias);
	      }
	  }
      };
      function run_complete(response)
      {
	  response = JSON.parse(response);
	  if(response["ok"])
	  {
	      if("status" in response)
	      {
		  if(response["status"] === "success")
		  {
		      running_button.setAttribute("class", "run_button success end_running");
		      currentrun += "<span class='success' style='padding: 0 5px 0 5px; color: white; float:right;'>success</span>"
		  }
		  else
		  {
		      running_button.setAttribute("class", "run_button failure end_running");
		      currentrun += "<span class='failure' style='padding: 0 5px 0 5px; color: white; float:right;'>failure</span>"
		  }
	      }
	      else
	      {
		  running_button.setAttribute("class", "run_button end_running");
	      }
	      
	      running_button = null;
	      var logs = document.getElementById("logs");
	      if (logs.innerHTML == "waiting for logs...")
	      {
		  logs.setAttribute("class", "");
		  logs.innerHTML = "";
	      }
	      
	      var details = document.createElement("details");
	      details.innerHTML = "<summary>"+currentrun+"</summary>"+response["log"];
	      details.setAttribute("class", "logbox");
	      logs.prepend(document.createElement("br"));
	      logs.prepend(details);
	      if(run_queue.length > 0)
	      {
		  run_alias(run_queue.shift());
	      }
	  }
      };
      httpGet("/api/get.config.dict");
      </script>
    <div id="run_buttons"></div>
    <div id="logs" class="logbox">waiting for logs...</div>
  <body>
</html>
